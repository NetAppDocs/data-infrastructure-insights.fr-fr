---
sidebar: sidebar 
permalink: ws_manually_installing_agent_and_collector.html 
keywords: install, configure, agent, collector, workload, security, cloud secure 
summary: Les agents Workload Security peuvent être installés ou mis à jour manuellement, offrant ainsi plus de contrôle sur les logiciels installés sur votre locataire. 
---
= Installation manuelle de Workload Security Agent et Collector
:hardbreaks:
:allow-uri-read: 


[role="lead"]
Par défaut, lorsqu'une nouvelle version d'un agent ou d'un collecteur Workload Security est disponible, une notification de pré-mise à niveau est envoyée et les agents et les collecteurs sont mis à jour automatiquement sur votre locataire.  Cependant, dans un environnement contrôlé et sécurisé, les mises à niveau automatiques peuvent ne pas être souhaitées.  Dans de tels cas, Workload Security peut être configuré pour l'installation/mise à niveau manuelle des agents et des collecteurs, offrant ainsi plus de contrôle sur les logiciels installés sur vos systèmes.



== Avant de commencer

. Vérifiez dans Swagger que les catégories d’API nommées « cloudsecure_installers.agent » et « cloudsecure_installers.collector » sont disponibles.  Dans le cas contraire, la prise en charge de l’installation manuelle de l’agent n’est pas activée.  Veuillez contacter le support NetApp pour activer la fonctionnalité.
+
image:ws_manual_install_APIs.png["API d'installation manuelle"]

. Exécutez toutes les commandes mentionnées dans ce document en tant qu'utilisateur « root » ou, si vous exécutez avec un utilisateur différent, exécutez les commandes avec « sudo ».




== Installation d'un nouvel agent

. Créez un nouveau jeton d’accès à l’API Workload Security.
+
.. Accédez à *Admin > Accès API*.  Sélectionnez l’onglet « Jetons de sécurité de la charge de travail » et cliquez sur « + Jeton d’accès API ».
+
... Définissez un nom et une description faciles à identifier.
... Dans le menu déroulant « Quel type d’API ce jeton sera-t-il utilisé pour appeler ? », sélectionnez _Gestion des collecteurs_ et _Installation de l’agent et du collecteur_.
... Sélectionnez la durée d’expiration souhaitée.


.. Cliquez sur _Enregistrer_.




[[copy-access-token]]
. Copiez le jeton d’accès API généré.  Veuillez noter qu'une fois la fenêtre fermée, le jeton ne peut plus être récupéré.  Dans ce cas, vous devrez générer un nouveau jeton.
+
image:ws_create_and_save_token.png["Créer et enregistrer un jeton API"]

+
image:ws_create_and_save_token_confirm.png["Confirmer la création du jeton"]

+
.. Accédez à *Admin > Accès API > Documentation API* (en haut à droite de la page) et sélectionnez l'icône _Sécurité de la charge de travail_.  Cela ouvre la documentation Swagger pour les API de sécurité de la charge de travail.
+
image:ws_swagger_documentation_link.png["Documentation Swagger pour la sécurité des charges de travail"]

.. Autoriser l'accès aux API _Workload Security_.


. Cliquez sur le bouton _Autoriser_ en haut à droite de la page.
. Dans le champ de texte _Customer ApiKey (apiKey)_, collez le jeton API précédemment copié à partir de<<copy-access-token,Étape 1c>> .
. Cliquez sur _Autoriser_ et fermez la fenêtre.
+
image:ws_API_authorization.png["Autoriser l'API"]

+
.. Téléchargez le programme d'installation de l'agent.


. Dans Swagger, sélectionnez _cloudsecure_installers.agent_ > _/v1/cloudsecure/agents/installers/{platform}/latest_ (GET) API.  Cliquez sur _Essayer_.
. Dans le champ _plateforme_, entrez _linux_.  Cliquez sur _Exécuter_.
+
image:ws_installers_agent_api_swagger.png["API d'installation d'agent Swagger - haut"] image:ws_installers_agent_api_swagger-2.png["API d'installation d'agent Swagger - réponse"]

. Cliquez sur « Télécharger le fichier » pour télécharger le programme d'installation.
. Si le fichier d'installation est téléchargé en externe sur une machine différente du système sur lequel l'agent doit être installé, copiez le fichier d'installation sur ce système.
. Alternativement, vous pouvez copier la commande curl et l'exécuter directement sur le système sur lequel l'agent doit être installé.
+
** Ajoutez l’argument « -o {{file_name}} » à la commande curl pour enregistrer le fichier d’installation avec le nom souhaité.  Le nom réel du fichier d'installation peut être trouvé dans la section des en-têtes de réponse de Swagger.  Ce nom peut également être utilisé.
+
image:ws_installers_agent_api_swagger_installer_file.png["Choisir le dernier agent via API - Swagger"]

** Bien que le fichier puisse être téléchargé à n'importe quel emplacement, il est recommandé de le télécharger dans un dossier vide dans lequel le fichier d'installation .zip peut être extrait.
+
... Créez un nouveau dossier (recommandé), copiez le fichier d'installation dans ce dossier et décompressez-le :
+
[listing]
----
[root@demo-agent /]# mkdir agent_installers
[root@demo-agent /]# cd agent_installers/
[root@demo-agent agent_installers]# pwd
/agent_installers
[root@demo-agent agent_installers]# ll
total 0
[root@demo-agent agent_installers]# curl -X GET "https://netapp-demo.dev.cloudsecure.netapp.com/rest/v1/cloudsecure/agents/installers/linux/latest" -H "accept: application/octet-stream" -H "X-CloudInsights-ApiKey: <<API Access Token>>" -o cloudsecure-linux-agent-installer-1.617.0.zip
[root@demo-agent agent_installers]# ll
total 76012
-rw------- 1 root root 77834705 Apr 26 14:34 cloudsecure-linux-agent-installer-1.617.0.zip
----
+
[listing]
----
[root@demo-agent agent_installers]# unzip cloudsecure-linux-agent-installer-1.617.0.zip
Archive:  cloudsecure-linux-agent-installer-1.617.0.zip
  inflating: cloudsecure-agent-image.zip
  inflating: cloudsecure-agent-install.sh
  inflating: cloudsecure-agent-upgrade.sh
----
... Définissez l’autorisation _execute_ pour le fichier « cloudsecure-agent-install.sh ».
+
[listing]
----
[root@demo-agent agent_installers]# chmod +x cloudsecure-agent-install.sh
[root@demo-agent agent_installers]# ll
total 153344
-rw------- 1 root root 79154250 Apr 26 06:37 cloudsecure-agent-image.zip
-rwx------ 1 root root    16574 Apr 26 06:25 cloudsecure-agent-install.sh
-rw------- 1 root root     8586 Apr 26 06:25 cloudsecure-agent-upgrade.sh
-rw------- 1 root root 77834705 Apr 26 14:34 cloudsecure-linux-agent-installer-1.617.0.zip

----
... Générer un jeton unique pour l’installation d’un nouvel agent.
+
Remarque : le jeton à usage unique généré à cette étape est différent du jeton d’accès API généré à<<copy-access-token,Étape 1c>> .





. Dans Swagger, exécutez _cloudsecure_installers.agent > /v1/cloudsecure/agent/oneTimeToken_ API et copiez le jeton de la réponse.
+
.. Exportez le jeton unique en tant que variable d’environnement.
+
[listing]
----
[root@demo-agent ~]# export TOKEN=<<one time token generated in step 7>>
----
.. Si un serveur proxy est utilisé, exportez https_proxy en tant que variable d'environnement au format mentionné ci-dessous.
+
[listing]
----
[root@demo-agent ~]# export HTTPS_PROXY='USER:PASSWORD@PROXY_SERVER:PORT'
----
.. Facultatif : Par défaut, l’agent et les collecteurs seront installés dans le chemin « /opt/netapp ».  Pour installer dans un chemin différent, définissez la variable d'environnement suivante :
+
[listing]
----
[root@demo-agent ~]# export AGENT_INSTALL_PATH=/test_user/apps
----
+
Remarque : s'ils sont installés dans un chemin personnalisé, les collecteurs de données et tous les autres artefacts tels que les journaux d'agent seront créés uniquement dans le chemin personnalisé.  Les journaux d'installation seront toujours présents dans - _/var/log/netapp/cloudsecure/install_.

.. Revenez au répertoire où le programme d'installation de l'agent a été téléchargé et exécutez « cloudsecure-agent-install.sh »
+
[listing]
----
[root@demo-agent agent_installers]# ./ cloudsecure-agent-install.sh
----
+
Remarque : si l’utilisateur n’exécute pas un shell « bash », la commande d’exportation risque de ne pas fonctionner.  Dans ce cas, les étapes 8 à 11 peuvent être combinées et exécutées comme ci-dessous.  HTTPS_PROXY et AGENT_INSTALL_PATH sont facultatifs et peuvent être ignorés s'ils ne sont pas nécessaires.

+
[listing]
----
sudo /bin/bash -c "TOKEN=<<one time token generated in step 7>> HTTPS_PROXY=<<proxy details in the format mentioned in step 9>> AGENT_INSTALL_PATH=<<custom_path_to_install_agent>> ./cloudsecure-agent-install.sh"
----
+
À ce stade, l’agent devrait être installé avec succès.

.. Vérification de cohérence pour l'installation de l'agent :


. Exécutez « systemctl status cloudsecure-agent.service » et vérifiez que le service de l’agent est en état _running_.
+
[listing]
----
[root@demo-agent ~]# systemctl status cloudsecure-agent.service
 cloudsecure-agent.service - Cloud Secure Agent Daemon Service
   Loaded: loaded (/usr/lib/systemd/system/cloudsecure-agent.service; enabled; vendor preset: disabled)
   Active: active (running) since Fri 2024-04-26 02:50:37 EDT; 12h ago
 Main PID: 15887 (java)
    Tasks: 72
   CGroup: /system.slice/cloudsecure-agent.service
           ├─15887 java -Dconfig.file=/test_user/apps/cloudsecure/agent/conf/application.conf -Dagent.proxy.host= -Dagent.proxy.port= -Dagent.proxy.user= -Dagent.proxy.password= -Dagent.env=prod -Dagent.base.path=/test_user/apps/cloudsecure/agent -...

----
. L'agent doit être visible dans la page « Agents » et doit être dans l'état « connecté ».
+
image:ws_agentsPageShowingConnected.png["Interface utilisateur affichant les agents connectés"]

+
.. Nettoyage après installation.


. Si l’installation de l’agent réussit, les fichiers d’installation de l’agent téléchargés peuvent être supprimés.




== Installation d'un nouveau collecteur de données.

Remarque : ce document contient des instructions pour l’installation du « collecteur de données ONTAP SVM ».  Les mêmes étapes s'appliquent au « collecteur de données Cloud Volumes ONTAP » et au « collecteur de données Amazon FSx for NetApp ONTAP ».

. Accédez au système sur lequel le collecteur doit être installé et créez un répertoire nommé _./tmp/collectors_ sous le répertoire _agent installation path_.
+
Remarque : si l'agent est installé dans _/opt/netapp_, accédez à _/opt/netapp/cloudsecure_.

+
[listing]
----
[root@demo-agent ~]# cd {agent-install-path}/cloudsecure
[root@demo-agent ~]# mkdir -p ./tmp/collectors
----
. Modifiez de manière récursive la propriété du répertoire _tmp_ en *cssys:cssys* (l'utilisateur et le groupe cssys seront créés lors de l'installation de l'agent).
+
[listing]
----
[root@demo-agent /]# chown -R cssys:cssys tmp/
[root@demo-agent /]# cd ./tmp
[root@demo-agent tmp]# ll | grep collectors
drwx------ 2 cssys         cssys 4096 Apr 26 15:56 collectors
----
. Nous devons maintenant récupérer la version du collecteur et l'UUID du collecteur.  Accédez à l’API « cloudsecure_config.collector-types ».
. Accédez à Swagger, API « cloudsecure_config.collector-types > /v1/cloudsecure/collector-types » (GET).  Dans la liste déroulante « collectorCategory », sélectionnez le type de collecteur « DATA ».  Sélectionnez « TOUS » pour récupérer tous les détails du type de collecteur.
. Copiez l'UUID du type de collecteur requis.
+
image:ws_collectorAPIShowingUUID.png["Réponse de l'API du collecteur affichant l'UUID"]

. Téléchargez le programme d'installation du collecteur.
+
.. Accédez à l'API « cloudsecure_installers.collector > /v1/cloudsecure/collector-types/installers/{collectorTypeUUID} » (GET).  Saisissez l’UUID copié à l’étape précédente et téléchargez le fichier d’installation.
+
image:ws_downloadCollectorByUUID.png["API pour télécharger le collecteur par UUID"]

.. Si le fichier d'installation est téléchargé en externe sur une autre machine, copiez le fichier d'installation sur le système sur lequel l'agent est exécuté et placez-le dans le répertoire _/{agent-install-path}/cloudsecure/tmp/collectors_.
.. Alternativement, vous pouvez copier la commande curl à partir de la même API et l'exécuter directement sur le système sur lequel le collecteur doit être installé.
+
Notez que le nom du fichier doit être le même que celui présent dans les en-têtes de réponse de l'API du collecteur de téléchargement. voir la capture d'écran ci-dessous.

+
Remarque : si l'agent est installé dans _/opt/netapp_, accédez à _/opt/netapp/cloudsecure/tmp/collectors_.

+
image:ws_curl_command.png["Exemple de commande Curl montrant un jeton obscurci"]

+
[listing]
----
[root@demo-agent collectors]# cd {agent-install-path}/cloudsecure/tmp/collectors
[root@demo-agent collectors]# pwd
/opt/netapp/cloudsecure/tmp/collectors

[root@demo-agent collectors]# curl -X GET "https://netapp-demo.dev.cloudsecure.netapp.com/rest/v1/cloudsecure/collector-types/installers/1829df8a-c16d-45b1-b72a-ed5707129870" -H "accept: application/octet-stream" -H "X-CloudInsights-ApiKey: <<API Access Token>>" -o cs-ontap-dsc_1.286.0.zip
----


. Changer la propriété du fichier zip d'installation du collecteur en *cssys:cssys*.
+
[listing]
----
-rw------- 1 root root 50906252 Apr 26 16:11 cs-ontap-dsc_1.286.0.zip
[root@demo-agent collectors]# chown cssys:cssys cs-ontap-dsc_1.286.0.zip
[root@demo-agent collectors]# ll
total 49716
-rw------- 1 cssys cssys 50906252 Apr 26 16:11 cs-ontap-dsc_1.286.0.zip
----
. Accédez à *Sécurité de la charge de travail > Collecteurs* et sélectionnez *+Collecteur*.  Choisissez le collecteur _ONTAP SVM_.
. Configurez les détails du collecteur et _Enregistrez_ le collecteur.
. Après avoir cliqué sur _Enregistrer_, le processus de l'agent localisera le programme d'installation du collecteur dans le répertoire _/{agent-install-path}/cloudsecure/tmp/collectors/_ et installera le collecteur.
. En guise d'alternative, au lieu d'ajouter le collecteur via l'interface utilisateur, il peut également être ajouté via l'API.
+
.. Accédez à « cloudsecure_config.collectors » > API « /v1/cloudsecure/collectors » (POST).
.. Dans la liste déroulante des exemples, sélectionnez « Exemple de collecteur de données JSON ONTAP SVM », mettez à jour les détails de configuration du collecteur et exécutez.
+
image:ws_API_add_collector.png["API pour ajouter un collecteur"]



. Le collecteur devrait maintenant être visible dans la section « Collecteurs de données ».
+
image:ws_collectorPageList.png["Page de liste de l'interface utilisateur affichant les collecteurs"]

. Nettoyage après installation.
+
.. Si l'installation du collecteur réussit, tous les fichiers du répertoire _/{agent-install-path}/cloudsecure/tmp/collectors_ peuvent être supprimés.






== Installation d'un nouveau collecteur d'annuaires utilisateurs

Remarque : dans ce document, nous avons mentionné les étapes d’installation d’un collecteur LDAP.  Les mêmes étapes s’appliquent pour l’installation d’un collecteur AD.

. 1. Accédez au système sur lequel le collecteur doit être installé et créez un répertoire nommé _./tmp/collectors_ sous le répertoire _agent installation path_.
+
Remarque : si l'agent est installé dans _/opt/netapp_, accédez à _/opt/netapp/cloudsecure_.

+
[listing]
----
[root@demo-agent ~]# cd {agent-install-path}/cloudsecure
[root@demo-agent ~]# mkdir -p ./tmp/collectors
----
+
.. Changer la propriété du répertoire _collectors_ en *cssys:cssys*
+
[listing]
----
[root@demo-agent /]# chown -R cssys:cssys tmp/
[root@demo-agent /]# cd ./tmp

[root@demo-agent tmp]# ll | grep collectors
drwx------ 2 cssys         cssys 4096 Apr 26 15:56 collectors

----


. Nous devons maintenant récupérer la version et l’UUID du collecteur.  Accédez à l’API « cloudsecure_config.collector-types ».  Dans la liste déroulante collectorCategory, sélectionnez le type de collecteur comme « UTILISATEUR ».  Sélectionnez « TOUS » pour récupérer tous les détails du type de collecteur en une seule requête.
+
image:ws_API_collector_all.png["API pour obtenir tous les collecteurs"]

. Copiez l'UUID du collecteur LDAP.
+
image:ws_LDAP_collector_UUID.png["Réponse de l'API affichant l'UUID du collecteur LDAP"]

. Téléchargez le programme d'installation du collecteur.
+
.. Accédez à « cloudsecure_installers.collector » > API « /v1/cloudsecure/collector-types/installers/{collectorTypeUUID} » (GET).  Saisissez l’UUID copié à l’étape précédente et téléchargez le fichier d’installation.
+
image:ws_LDAP_collector_UUID_download.png["API et réponse au collecteur de téléchargement"]

.. Si le fichier d'installation est téléchargé en externe sur une autre machine, copiez le fichier d'installation sur le système sur lequel l'agent est exécuté et dans le répertoire _/{agent-installation-path}/cloudsecure/tmp/collectors_.
.. Alternativement, vous pouvez copier la commande curl à partir de la même API et l'exécuter directement sur le système sur lequel le collecteur doit être installé.
+
Notez que le nom du fichier doit être le même que celui présent dans les en-têtes de réponse de l'API du collecteur de téléchargement. voir la capture d'écran ci-dessous.

+
Notez également que si l'agent est installé dans _/opt/netapp_, accédez à _/opt/netapp/cloudsecure/tmp/collectors_.

+
image:ws_curl_command.png["API de commande Curl"]



+
[listing]
----
[root@demo-agent collectors]# cd {agent-install-path}/cloudsecure/tmp/collectors
[root@demo-agent collectors]# pwd
/opt/netapp/cloudsecure/tmp/collectors

[root@demo-agent collectors]# curl -X GET "https://netapp-demo.dev.cloudsecure.netapp.com/rest/v1/cloudsecure/collector-types/installers/37fb37bd-6078-4c75-a64f-2b14cb1a1eb1" -H "accept: application/octet-stream" -H "X-CloudInsights-ApiKey: <<API Access Token>>" -o cs-ldap-dsc_1.322.0.zip
----
. Changer la propriété du fichier zip d'installation du collecteur en cssys:cssys.
+
[listing]
----
[root@demo-agent collectors]# ll
total 37156
-rw------- 1 root root 38045966 Apr 29 10:02 cs-ldap-dsc_1.322.0.zip
[root@demo-agent collectors]# chown cssys:cssys cs-ldap-dsc_1.322.0.zip
[root@demo-agent collectors]# ll
total 37156
-rw------- 1 cssys cssys 38045966 Apr 29 10:02 cs-ldap-dsc_1.322.0.zip

----
. Accédez à la page « Collecteurs d’annuaires utilisateurs » et cliquez sur « + Collecteur d’annuaires utilisateurs ».
+
image:ws_user_directory_collector.png["Ajout d'un collecteur d'annuaire utilisateur"]

. Sélectionnez « Serveur d'annuaire LDAP ».
+
image:ws_LDAP_user_select.png["Fenêtre d'interface utilisateur pour la sélection d'un utilisateur LDAP"]

. Saisissez les détails du serveur d'annuaire LDAP et cliquez sur « Enregistrer »
+
image:ws_LDAP_user_Details.png["Interface utilisateur affichant les détails de l'utilisateur LDAP"]

. Après avoir cliqué sur _Enregistrer_, le service de l'agent localisera le programme d'installation du collecteur dans le répertoire _/{agent-install-path}/cloudsecure/tmp/collectors/_ et installera le collecteur.
. En guise d'option alternative, au lieu d'ajouter un collecteur via l'interface utilisateur, il peut également être ajouté via l'API.
+
.. Accédez à « cloudsecure_config.collectors » > API « /v1/cloudsecure/collectors » (POST).
.. Dans la liste déroulante des exemples, sélectionnez « Exemple de collecteur d'utilisateurs json du serveur d'annuaire LDAP », mettez à jour les détails de configuration du collecteur et cliquez sur « Exécuter ».
+
image:ws_API_LDAP_Collector.png["API pour le collecteur LDAP"]



. Le collecteur devrait maintenant être visible dans la section « Collecteurs d’annuaires utilisateurs ».
+
image:ws_LDAP_collector_list.png["Liste des collecteurs LDAP dans l'interface utilisateur"]

. Nettoyage après installation.
+
.. Si l'installation du collecteur réussit, tous les fichiers du répertoire _/{agent-install-path}/cloudsecure/tmp/collectors_ peuvent être supprimés.






== Mise à niveau d'un agent

Une notification par e-mail sera envoyée lorsqu'une nouvelle version de l'agent/collecteur sera disponible.

. Téléchargez le dernier programme d'installation de l'agent.
+
.. Les étapes pour télécharger le dernier programme d’installation sont similaires à celles décrites dans « Installation d’un nouvel agent ».  Dans Swagger, sélectionnez « cloudsecure_installers.agent » > API « /v1/cloudsecure/agents/installers/{platform}/latest », entrez la plateforme « linux » et téléchargez le fichier zip du programme d'installation.  Alternativement, une commande curl peut également être utilisée.  Décompressez le fichier d'installation.


. Définissez l'autorisation d'exécution pour le fichier « cloudsecure-agent-upgrade.sh ».
+
[listing]
----
[root@demo-agent agent_installers]# unzip cloudsecure-linux-agent-installer-1.618.0.zip
Archive:  cloudsecure-linux-agent-installer-1.618.0.zip
  inflating: cloudsecure-agent-image.zip
  inflating: cloudsecure-agent-install.sh
  inflating: cloudsecure-agent-upgrade.sh
[root@demo-agent agent_installers]# ll
total 153344
-rw------- 1 root root 79154230 Apr 26  2024 cloudsecure-agent-image.zip
-rw------- 1 root root    16574 Apr 26  2024 cloudsecure-agent-install.sh
-rw------- 1 root root     8586 Apr 26  2024 cloudsecure-agent-upgrade.sh
-rw------- 1 root root 77834660 Apr 26 17:35 cloudsecure-linux-agent-installer-1.618.0.zip
[root@demo-agent agent_installers]# chmod +x cloudsecure-agent-upgrade.sh
[root@demo-agent agent_installers]# ll
total 153344
-rw------- 1 root root 79154230 Apr 26  2024 cloudsecure-agent-image.zip
-rw------- 1 root root    16574 Apr 26  2024 cloudsecure-agent-install.sh
-rwx------ 1 root root     8586 Apr 26  2024 cloudsecure-agent-upgrade.sh
-rw------- 1 root root 77834660 Apr 26 17:35 cloudsecure-linux-agent-installer-1.618.0.zip

----
. Exécutez le script « cloudsecure-agent-upgrade.sh ».  Si le script s'est exécuté avec succès, il affichera le message « L'agent Cloudsecure a été mis à niveau avec succès. » dans la sortie.
. Exécutez la commande suivante « systemctl daemon-reload »
+
[listing]
----
[root@demo-agent ~]# systemctl daemon-reload
----
. Redémarrez le service de l'agent.
+
[listing]
----
[root@demo-agent ~]# systemctl restart cloudsecure-agent.service
----
+
À ce stade, l’agent devrait être mis à niveau avec succès.

. Vérification de santé mentale après la mise à niveau de l'agent.
+
.. Accédez au chemin où l’agent est installé (par exemple, « /opt/netapp/cloudsecure/ »).  Le lien symbolique « agent » doit pointer vers la nouvelle version de l’agent.
+
[listing]
----
[root@demo-agent cloudsecure]# pwd
/opt/netapp/cloudsecure
[root@demo-agent cloudsecure]# ll
total 40
lrwxrwxrwx  1 cssys cssys  114 Apr 26 17:38 agent -> /test_user/apps/cloudsecure/cloudsecure-agent-1.618.0
drwxr-xr-x  4 cssys cssys 4096 Apr 25 10:45 agent-certs
drwx------  2 cssys cssys 4096 Apr 25 16:18 agent-logs
drwx------ 11 cssys cssys 4096 Apr 26 02:50 cloudsecure-agent-1.617.0
drwx------ 11 cssys cssys 4096 Apr 26 17:42 cloudsecure-agent-1.618.0
drwxr-xr-x  3 cssys cssys 4096 Apr 26 02:45 collector-image
drwx------  2 cssys cssys 4096 Apr 25 10:45 conf
drwx------  3 cssys cssys 4096 Apr 26 16:39 data-collectors
-rw-r--r--  1 root  root    66 Apr 25 10:45 sysctl.conf.bkp
drwx------  2 root  root  4096 Apr 26 17:38 tmp

----
.. L'agent doit être visible dans la page « Agents » et doit être dans l'état « connecté ».
+
image:ws_agentsPageShowingConnected.png["Interface utilisateur montrant les agents connectés"]



. Nettoyage après installation.
+
.. Si l’installation de l’agent réussit, les fichiers d’installation de l’agent téléchargés peuvent être supprimés.






== Mise à niveau des collecteurs

Remarque : les étapes de mise à niveau sont les mêmes pour tous les types de collecteurs.  Nous allons démontrer la mise à niveau du collecteur «ONTAP SVM » dans ce document.

. Accédez au système dans lequel les collecteurs doivent être mis à niveau et créez le répertoire _./tmp/collectors_ sous le répertoire _agent installation path_, s'il n'est pas déjà présent.
+
Remarque : si l'agent est installé dans _/opt/netapp_, accédez au répertoire _/opt/netapp/cloudsecure_.

+
[listing]
----
[root@demo-agent ~]# cd {agent-install-path}/cloudsecure
[root@demo-agent ~]# mkdir -p ./tmp/collectors
----
. Assurez-vous que le répertoire « collectors » appartient à _cssys:cssys_.
+
[listing]
----
[root@demo-agent /]# chown -R cssys:cssys tmp/
[root@demo-agent /]# cd ./tmp
[root@demo-agent tmp]# ll | grep collectors
drwx------ 2 cssys         cssys 4096 Apr 26 15:56 collectors
----
. Dans Swagger, accédez à l'API GET « cloudsecure_config.collector-types ».  Dans la liste déroulante « collectorCategory », sélectionnez « DATA » (sélectionnez « USER » pour le collecteur de répertoires d'utilisateurs ou « TOUS »).
+
Copiez l'UUID et la version à partir du corps de la réponse.

+
image:ws_collector_uuid_and_version.png["Réponse de l'API montrant l'UUID du collecteur et la version en surbrillance"]

. Téléchargez le dernier fichier d'installation du collecteur.
+
.. Accédez à _cloudsecure_installers.collector_ > _/v1/cloudsecure/collector-types/installers/{collectorTypeUUID}_ API.  Saisissez _collectorTypeUUID_ copié à l’étape précédente.  Téléchargez le programme d'installation dans le répertoire _/{agent-install-path}/cloudsecure/tmp/collectors_.
.. Alternativement, la commande curl de la même API peut également être utilisée.
+
image:ws_curl_command_only.png["Exemple de commande Curl"]

+
Remarque : le nom du fichier doit être le même que celui présent dans les en-têtes de réponse de l'API du collecteur de téléchargement.



. Changer la propriété du fichier zip d'installation du collecteur en cssys:cssys.
+
[listing]
----
[root@demo-agent collectors]# ll
total 55024
-rw------- 1 root root 56343750 Apr 26 19:00 cs-ontap-dsc_1.287.0.zip
[root@demo-agent collectors]# chown cssys:cssys cs-ontap-dsc_1.287.0.zip
[root@demo-agent collectors]# ll
total 55024
-rw------- 1 cssys cssys 56343750 Apr 26 19:00 cs-ontap-dsc_1.287.0.zip

----
. Déclencher l'API du collecteur de mise à niveau.
+
.. Dans Swagger, accédez à « cloudsecure_installers.collector » > API « /v1/cloudsecure/collector-types/upgrade » (PUT).
.. Dans la liste déroulante « Exemples », sélectionnez « Exemple de mise à niveau du collecteur de données ONTAP SVM json » pour renseigner l’exemple de charge utile.
.. Remplacer la version par la version copiée à partir de<<copy-access-token,Étape 3>> et cliquez sur « Exécuter ».
+
image:ws_svm_ontap_collector_upgrade_example_json.png["Exemple de mise à niveau SVM dans l'interface utilisateur Swagger"]

+
Attendez quelques secondes.  Les collectionneurs seront automatiquement mis à niveau.



. Vérification de santé mentale.
+
Les collecteurs doivent être en état d'exécution dans l'interface utilisateur.

. Nettoyage après la mise à niveau :
+
.. Si la mise à niveau du collecteur réussit, tous les fichiers du répertoire _/{agent-install-path}/cloudsecure/tmp/collectors_ peuvent être supprimés.




Répétez les étapes ci-dessus pour mettre à niveau d’autres types de collecteurs également.



== Problèmes et correctifs communs.

. Erreur AGENT014
+
Cette erreur se produit si le fichier d'installation du collecteur n'est pas présent dans le répertoire _/{agent-install-path}/cloudsecure/tmp/collectors_ ou s'il n'est pas accessible.  Assurez-vous que le fichier d'installation est téléchargé et que la structure complète du répertoire _collectors_ et le fichier zip d'installation appartiennent à cssys:cssys, puis redémarrez le service de l'agent : _systemctl restart cloudsecure-agent.service_.

+
image:ws_agent014_error.png["Écran d'interface utilisateur affichant l'infobulle de survol de l'erreur « agent 014 »"]

. Erreur non autorisée
+
[listing]
----
{
  "errorMessage": "Requested public API is not allowed to be accessed by input API access token.",
  "errorCode": "NOT_AUTHORIZED"
}

----
+
Cette erreur s'affichera si le jeton d'accès API est généré sans sélectionner toutes les catégories d'API requises.  Générez un nouveau jeton d’accès API en sélectionnant toutes les catégories d’API requises.


